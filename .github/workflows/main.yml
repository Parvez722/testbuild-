name: Ubuntu 24.04 SSH (Localtonet)

on:
  workflow_dispatch:

jobs:
  ssh-server:
    runs-on: ubuntu-24.04
    timeout-minutes: 360

    steps:
      - name: Update system
        run: |
          sudo apt update
          sudo apt upgrade -y

      - name: Install SSH server
        run: |
          sudo apt install -y openssh-server curl
          sudo systemctl enable ssh
          sudo systemctl start ssh

      - name: Set root password
        run: |
          echo "root:root" | sudo chpasswd
          sudo sed -i 's/^#PermitRootLogin.*/PermitRootLogin yes/' /etc/ssh/sshd_config
          sudo sed -i 's/^PasswordAuthentication.*/PasswordAuthentication yes/' /etc/ssh/sshd_config
          sudo systemctl restart ssh

      - name: Install Localtonet
        run: |
          curl -fsSL https://localtonet.com/install | sudo bash

      - name: Start Localtonet SSH tunnel
        env:
          LOCALTONET_TOKEN: ${{ secrets.LOCALTONET_TOKEN }}
        run: |
          sudo localtonet auth --token "$LOCALTONET_TOKEN"
          sudo localtonet tcp --port 22

      - name: Keep runner alive
        run: |
          echo "SSH server is running"
          sleep 6h
