name: Ubuntu 24.04 SSH via Localtonet

on:
  workflow_dispatch:

jobs:
  ssh:
    runs-on: ubuntu-24.04
    timeout-minutes: 360

    steps:
      - name: Update system
        run: |
          sudo apt update
          sudo apt install -y unzip curl openssh-server

      - name: Enable SSH
        run: |
          sudo systemctl enable ssh
          sudo systemctl start ssh

      - name: Set root login (temporary)
        run: |
          echo "root:root" | sudo chpasswd
          sudo sed -i 's/^#PermitRootLogin.*/PermitRootLogin yes/' /etc/ssh/sshd_config
          sudo sed -i 's/^PasswordAuthentication.*/PasswordAuthentication yes/' /etc/ssh/sshd_config
          sudo systemctl restart ssh

      - name: Download Localtonet
        run: |
          cd /tmp
          wget https://localtonet.com/download/localtonet-linux-x64.zip
          unzip localtonet-linux-x64.zip
          sudo mv localtonet /usr/local/bin/localtonet
          sudo chmod +x /usr/local/bin/localtonet

      - name: Authenticate Localtonet
        env:
          LOCALTONET_TOKEN: ${{ secrets.LOCALTONET_TOKEN }}
        run: |
          sudo /usr/local/bin/localtonet auth --token
          V1KSLyw3BCWJGlF5rAeio6OXYjTRN2Eqg

      - name: Share SSH (port 22)
        run: |
          sudo /usr/local/bin/localtonet tcp --port 22

      - name: Keep runner alive
        run: |
          echo "SSH tunnel is active"
          sleep 6h
